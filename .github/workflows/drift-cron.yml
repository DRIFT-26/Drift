name: DRIFT Scheduled Jobs

on:
  schedule:
    # Timezone-aware dispatch (API decides who runs now)
    - cron: "*/15 * * * *"   # every 15 minutes (UTC)

    # Keep Stripe data fresh daily
    - cron: "0 6 * * *"      # daily 6:00 UTC

    # Weekly deeper refresh
    - cron: "0 7 * * 0"      # Sunday 7:00 UTC
  workflow_dispatch: {}

jobs:
  run-drift:
    runs-on: ubuntu-latest
    steps:
      # ✅ Dispatch runs ONLY on 15-min schedule
      - name: Dispatch Daily (timezone-aware)
        if: github.event.schedule == '*/15 * * * *'
        run: |
          curl -s -X POST "https://drift-app-indol.vercel.app/api/jobs/daily?dispatch=1" \
            -H "Authorization: Bearer ${{ secrets.Cron_Secret }}" | jq

      - name: Dispatch Weekly (timezone-aware)
        if: github.event.schedule == '*/15 * * * *'
        run: |
          curl -s -X POST "https://drift-app-indol.vercel.app/api/jobs/weekly?dispatch=1" \
            -H "Authorization: Bearer ${{ secrets.Cron_Secret }}" | jq

      # ✅ Data refresh jobs
      - name: Daily Stripe Ingest (14d)
        if: github.event.schedule == '0 6 * * *'
        run: |
          curl -s -X POST "https://drift-app-indol.vercel.app/api/jobs/stripe-ingest?days=14" \
            -H "Authorization: Bearer ${{ secrets.Cron_Secret }}" | jq

      - name: Weekly Baseline Refresh (90d)
        if: github.event.schedule == '0 7 * * 0'
        run: |
          curl -s -X POST "https://drift-app-indol.vercel.app/api/jobs/stripe-ingest?days=90" \
            -H "Authorization: Bearer ${{ secrets.Cron_Secret }}" | jq
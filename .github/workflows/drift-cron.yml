name: DRIFT Scheduled Jobs

on:
  schedule:
    # Daily at 6:00 AM UTC — keeps the recent window fresh
    - cron: "0 6 * * *"

    # Weekly on Sundays at 7:00 AM UTC — refresh baseline + weekly digest
    - cron: "0 7 * * 0"
  workflow_dispatch: {}

jobs:
  run-drift-jobs:
    runs-on: ubuntu-latest
    steps:
      - name: Daily Stripe Ingest (14d)
        run: |
          curl -s -X POST "https://drift-app-indol.vercel.app/api/jobs/stripe-ingest?days=14" \
            -H "Authorization: Bearer ${{ secrets.DRIFT_CRON_SECRET }}" | jq

      - name: Daily Compute (Drift Engine)
        run: |
          curl -s -X POST "https://drift-app-indol.vercel.app/api/jobs/daily" \
            -H "Authorization: Bearer ${{ secrets.DRIFT_CRON_SECRET }}" | jq

      # ✅ Weekly-only steps (won't run on the daily cron)
      - name: Weekly Baseline Refresh (90d)
        if: github.event_name == 'schedule' && github.event.schedule == '0 7 * * 0'
        run: |
          curl -s -X POST "https://drift-app-indol.vercel.app/api/jobs/stripe-ingest?days=90" \
            -H "Authorization: Bearer ${{ secrets.DRIFT_CRON_SECRET }}" | jq

      - name: Weekly Executive Digest
        if: github.event_name == 'schedule' && github.event.schedule == '0 7 * * 0'
        run: |
          curl -s -X POST "https://drift-app-indol.vercel.app/api/jobs/weekly" \
            -H "Authorization: Bearer ${{ secrets.DRIFT_CRON_SECRET }}" | jq         